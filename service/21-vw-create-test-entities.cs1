#!/usr/bin/env -S dotnet run --file
#:package VwConnector@1.34.3-rev.2
#:package Kokuban@0.2.0
#:package Lestaly.General@0.114.0
#:package RefFile@0.2.0
#:property PublishAot=false
using Lestaly;
using VwConnector;
using VwConnector.Agent;
[assembly: RefFile(".settings.cs1")]

return await Paved.ProceedAsync(noPause: args.RoughContains("--no-pause"), async () =>
{
    using var signal = new SignalCancellationPeriod();

    var vwSettings = new Settings();
    var testUser = vwSettings.Setup.TestUser;
    var testOrg = vwSettings.Setup.TestOrg;

    Console.WriteLine("Prepare test user");
    using var connector = new VaultwardenConnector(vwSettings.Service.Url);
    var adminToken = await connector.Admin.GetTokenAsync(vwSettings.Setup.Admin.Password, signal.Token);
    var users = await connector.Admin.UsersAsync(adminToken, signal.Token);
    if (users.Any(u => u.email == testUser.Mail))
    {
        Console.WriteLine(".. Already exists");
        return;
    }

    Console.WriteLine("Register test user");
    await connector.Account.RegisterUserNoSmtpAsync(new(testUser.Mail, testUser.Password));
    var agent = await VaultwardenAgent.CreateAsync(connector, new(testUser.Mail, testUser.Password), signal.Token);
    Console.WriteLine($".. Created - {agent.Profile.id}");

    Console.WriteLine("Prepare test org");
    var org = await agent.Affect.CreateOrganizationAsync(testOrg.Name, "DefaultCollection", signal.Token);
    Console.WriteLine($".. Created - {org.Id}");

    Console.WriteLine("Prepare test collections");
    foreach (var name in testOrg.Collections)
    {
        Console.WriteLine($"  {name}");
        var collection = await agent.Affect.CreateCollectionAsync(org.Id, name, signal.Token);
        Console.WriteLine($"  .. Created - {collection.Id}");
    }

});
